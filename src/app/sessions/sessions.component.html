<!-- Loading Screen Overlay, inspired by findpartners.html -->
<!-- FIXED: Changed isLoading to isLoading$ to match the component property -->
<div *ngIf="isLoading$ | async" class="loading-overlay">
  <div class="spinner"></div>
  <p class="loading-text">Loading your sessions...</p>
</div>

<!-- Main Content, with a structure similar to findpartners.html -->
<!-- FIXED: Changed isLoading to isLoading$ to match the component property -->
<main *ngIf="!(isLoading$ | async)" class="sessions-page-container">
  <!-- Page Header -->
  <header class="page-header">
    <!-- FIXED: Added inline style to increase space below the heading -->
    <h1 style="margin-bottom: 0.75rem;">Study Sessions</h1>
    <p>Organize and track your group study sessions</p>
    <button class="create-session-btn" (click)="createSession()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      <span>Create Session</span>
    </button>
  </header>

  <!-- User Stats Section -->
  <section class="stats-section" *ngIf="userStats">
    <div class="stat-card">
      <h3>{{ userStats.totalHours }} hrs</h3>
      <p>Study Time (Last 7 Days)</p>
    </div>
    <div class="stat-card">
      <h3>{{ userStats.numSessions }}</h3>
      <p>Sessions Attended (Last 7 Days)</p>
    </div>
    <div class="stat-card">
      <h3>{{ upcomingSessions.length }}</h3>
      <p>Upcoming Sessions</p>
    </div>
  </section>

  <!-- Sessions Grid -->
  <div class="sessions-grid">
    <!-- Upcoming Sessions Column -->
    <section class="sessions-column">
      <header class="column-header">
        <h2>Upcoming</h2>
      </header>
      <div *ngIf="upcomingSessions.length === 0" class="no-results-card">
        <p>You have no upcoming sessions.</p>
        <span>Create one to get started!</span>
      </div>
      <article class="session-card" *ngFor="let session of upcomingSessions">
        <header class="card-header">
          <div class="session-info">
            <h3>{{ session.title }}</h3>
            <div class="session-badges">
              <span class="badge status-{{ session.status }}">{{ session.status }}</span>
              <span class="badge type-{{ isOnline(session) ? 'online' : 'in-person' }}">
                {{ isOnline(session) ? 'Online' : 'In-Person' }}
              </span>
            </div>
          </div>
          <div class="card-actions">
            <button *ngIf="!isOnline(session) && session.location" (click)="getDirections(session)" title="Get Directions">üìç</button>
            <button *ngIf="isOnline(session) && session.location" (click)="joinOnline(session)" title="Join Online">üé•</button>
            <button (click)="viewDetails(session)" title="View Details">‚ÑπÔ∏è</button>
          </div>
        </header>
        <div class="card-body">
          <p class="session-time">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            {{ session.start_time | date:'fullDate' }}
          </p>
          <p class="session-time">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            {{ session.start_time | date:'shortTime' }} - {{ session.end_time | date:'shortTime' }}
          </p>
          <p *ngIf="session.location" class="session-location">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
            {{ session.location }}
          </p>
        </div>
        <footer class="card-footer" *ngIf="session.description">
          <p>{{ session.description }}</p>
        </footer>
      </article>
    </section>

    <!-- Past Sessions Column -->
    <section class="sessions-column">
      <header class="column-header">
        <h2>Past</h2>
      </header>
      <div *ngIf="pastSessions.length === 0" class="no-results-card">
        <p>No past sessions found.</p>
      </div>
      <article class="session-card past" *ngFor="let past of pastSessions">
        <header class="card-header">
          <div class="session-info">
            <h3>{{ past.title }}</h3>
            <p class="past-date">{{ past.start_time | date:'mediumDate' }}</p>
          </div>
          <div class="card-actions">
            <button (click)="viewSummary(past)" title="View Summary">üìÑ</button>
            <button (click)="scheduleAgain(past)" title="Schedule Again">üîÑ</button>
          </div>
        </header>
      </article>
    </section>
  </div>
</main>

<!-- Create Session Modal, restyled for consistency -->
<div class="modal-backdrop" *ngIf="showModal" (click)="cancelSession()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <header class="modal-header">
      <h2>Create New Session</h2>
      <button class="close-btn" (click)="cancelSession()">&times;</button>
    </header>

    <form class="modal-form" (ngSubmit)="confirmSession()">
      <div class="form-group">
        <label for="title">Session Title <span class="required">*</span></label>
        <input id="title" type="text" [(ngModel)]="newSession.title" name="title" placeholder="e.g., Calculus II Final Review" required />
      </div>

      <div class="form-group">
        <label for="group">Group <span class="required">*</span></label>
        <select id="group" [(ngModel)]="newSession.groupid" name="groupid" required>
          <option [value]="0" disabled>Select a group</option>
          <option *ngFor="let group of groups" [value]="group.groupid">{{ group.title }}</option>
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="start_time">Start Time <span class="required">*</span></label>
          <input id="start_time" type="datetime-local" [(ngModel)]="newSession.start_time" name="start_time" required />
        </div>
        <div class="form-group">
          <label for="end_time">End Time</label>
          <input id="end_time" type="datetime-local" [(ngModel)]="newSession.end_time" name="end_time" />
        </div>
      </div>

      <div class="form-group">
        <label for="location">Location or URL</label>
        <input id="location" type="text" [(ngModel)]="newSession.location" name="location" placeholder="e.g., Library Room 305 or https://meet.google.com/..." />
      </div>

      <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" [(ngModel)]="newSession.description" name="description" rows="3" placeholder="Add session details, topics to cover, etc."></textarea>
      </div>

      <p *ngIf="modalError" class="modal-error">{{ modalError }}</p>

      <footer class="modal-actions">
        <button type="button" class="btn-cancel" (click)="cancelSession()">Cancel</button>
        <button type="submit" class="btn-confirm">Create Session</button>
      </footer>
    </form>
  </div>
</div>

