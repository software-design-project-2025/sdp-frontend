<div *ngIf="isLoading$ | async" class="loading-overlay">
  <div class="spinner"></div>
  <p class="loading-text">Loading your sessions...</p>
</div>

<main *ngIf="!(isLoading$ | async)" class="sessions-page-container">
  <header class="page-header">
    <h1 style="margin-bottom: 0.75rem;">Study Sessions</h1>
    <p>Discover, join, and manage your study sessions.</p>
    <button class="create-session-btn" (click)="createSession()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      <span>Create Session</span>
    </button>
  </header>

  <section class="stats-section" *ngIf="userStats">
    <div class="stat-card">
      <h3>{{ userStats.totalHours }} hrs</h3>
      <p>Study Time (Last 7 Days)</p>
    </div>
    <div class="stat-card">
      <h3>{{ userStats.numSessions }}</h3>
      <p>Sessions Attended (Last 7 Days)</p>
    </div>
    <div class="stat-card">
      <h3>{{ upcomingSessions.length }}</h3>
      <p>Upcoming Sessions</p>
    </div>
  </section>

  <nav class="sessions-tabs">
    <button [class.active]="activeTab === 'discover'" (click)="activeTab = 'discover'">Discover</button>
    <button [class.active]="activeTab === 'future'" (click)="activeTab = 'future'">Future</button>
    <button [class.active]="activeTab === 'created'" (click)="activeTab = 'created'">My Sessions</button>
    <button [class.active]="activeTab === 'past'" (click)="activeTab = 'past'">Past</button>
  </nav>

  <div class="tab-content">

    <section *ngIf="activeTab === 'discover'">
      <div class="sessions-filters">
        <input type="text" [(ngModel)]="filters.search" placeholder="Search by title..." />
        <select [(ngModel)]="filters.module">
          <option value="">All Modules</option>
          <option *ngFor="let mod of modules" [value]="mod.courseCode">{{ mod.courseName }}</option>
        </select>
        <input type="date" [(ngModel)]="filters.startDate" />
        <button class="btn-filter" (click)="applyFilters()">Filter</button>
        <button class="btn-clear" (click)="clearFilters()">Clear</button>
      </div>

      <div class="session-list">
        <div *ngIf="allSessions.length === 0" class="no-results-card">
          <p>No active sessions match your filters.</p>
        </div>

        <article class="session-card" *ngFor="let session of allSessions">
          <header class="card-header">
            <div class="session-info">
              <h3>{{ session.title }}</h3>
              <div class="session-badges">
                <span class="badge status-{{ session.status }}">{{ session.status }}</span>
                <span class="badge type-{{ isOnline(session) ? 'online' : 'in-person' }}">
                  {{ isOnline(session) ? 'Online' : 'In-Person' }}
                </span>
              </div>
            </div>
            <div class="card-actions">
              <button *ngIf="session.sessionId" class="btn-join" (click)="onJoinSession(session.sessionId)">
                Join Session
              </button>
            </div>
          </header>
          <div class="card-body">
            <p class="session-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              {{ session.start_time | date:'fullDate' }}
            </p>
            <p class="session-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>

              {{ session.start_time | date:'shortTime' }} -
              <span *ngIf="session.end_time !== 'infinity'">{{ session.end_time | date:'shortTime' }}</span>
              <span *ngIf="session.end_time === 'infinity'">Ongoing</span>
            </p>
            <p *ngIf="session.location" class="session-location">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
              {{ session.location }}
            </p>
          </div>
          <footer class="card-footer" *ngIf="session.description">
            <p>{{ session.description }}</p>
          </footer>
        </article>
      </div>
    </section>

    <section *ngIf="activeTab === 'future'">
      <div class="session-list">
        <div *ngIf="upcomingSessions.length === 0" class="no-results-card">
          <p>You haven't joined any upcoming sessions.</p>
          <span>Check the "Discover" tab to find one!</span>
        </div>

        <article class="session-card" *ngFor="let session of upcomingSessions">
          <header class="card-header">
            <div class="session-info">
              <h3>{{ session.title }}</h3>
              <div class="session-badges">
                <span class="badge status-{{ session.status }}">{{ session.status }}</span>
                <span class="badge type-{{ isOnline(session) ? 'online' : 'in-person' }}">
                  {{ isOnline(session) ? 'Online' : 'In-Person' }}
                </span>
              </div>
            </div>
            <div class="card-actions" *ngIf="session.sessionId">
              <ng-container *ngIf="isCreator(session); else memberActions">
                <button class="btn-admin end" (click)="onEndSession(session.sessionId)" title="End Session Now">End</button>
                <button class="btn-admin extend" (click)="onExtendSession(session.sessionId)" title="Extend Session">Extend</button>
              </ng-container>
              <ng-template #memberActions>
                <button class="btn-leave" (click)="onLeaveSession(session.sessionId)">Leave Session</button>
              </ng-template>
            </div>
          </header>
          <div class="card-body">
            <p class="session-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              {{ session.start_time | date:'fullDate' }}
            </p>
            <p class="session-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>

              {{ session.start_time | date:'shortTime' }} -
              <span *ngIf="session.end_time !== 'infinity'">{{ session.end_time | date:'shortTime' }}</span>
              <span *ngIf="session.end_time === 'infinity'">Ongoing</span>
            </p>
            <p *ngIf="session.location" class="session-location">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
              {{ session.location }}
            </p>
          </div>
          <footer class="card-footer" *ngIf="session.description">
            <p>{{ session.description }}</p>
          </footer>
        </article>
      </div>
    </section>

    <section *ngIf="activeTab === 'created'">
      <div class="session-list">
        <div *ngIf="myCreatedSessions.length === 0" class="no-results-card">
          <p>You haven't created any sessions.</p>
          <span>Click "Create Session" to get started!</span>
        </div>

        <article class="session-card" *ngFor="let session of myCreatedSessions">
          <header class="card-header">
            <div class="session-info">
              <h3>{{ session.title }}</h3>
              <div class="session-badges">
                <span class="badge status-{{ session.status }}">{{ session.status }}</span>
                <span class="badge type-{{ isOnline(session) ? 'online' : 'in-person' }}">
                  {{ isOnline(session) ? 'Online' : 'In-Person' }}
                </span>
              </div>
            </div>
            <div class="card-actions" *ngIf="session.sessionId">
              <button *ngIf="session.status === 'scheduled'" class="btn-admin" (click)="onEditSession(session)" title="Edit Session">Edit</button>
              <button class="btn-admin end" (click)="onEndSession(session.sessionId)" title="End Session Now">End</button>
              <button class="btn-admin extend" (click)="onExtendSession(session.sessionId)" title="Extend Session">Extend</button>
              <button class="btn-delete" (click)="onDeleteSession(session.sessionId)" title="Delete Session">Delete</button>
            </div>
          </header>
          <div class="card-body">
            <p class="session-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              {{ session.start_time | date:'fullDate' }}
            </p>
            <p class="session-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>

              {{ session.start_time | date:'shortTime' }} -
              <span *ngIf="session.end_time !== 'infinity'">{{ session.end_time | date:'shortTime' }}</span>
              <span *ngIf="session.end_time === 'infinity'">Ongoing</span>
            </p>
            <p *ngIf="session.location" class="session-location">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
              {{ session.location }}
            </p>
          </div>
          <footer class="card-footer" *ngIf="session.description">
            <p>{{ session.description }}</p>
          </footer>
        </article>
      </div>
    </section>

    <section *ngIf="activeTab === 'past'">
      <div class="session-list">
        <div *ngIf="pastSessions.length === 0" class="no-results-card">
          <p>No past sessions found.</p>
        </div>
        <article class="session-card past" *ngFor="let past of pastSessions">
          <header class="card-header">
            <div class="session-info">
              <h3>{{ past.title }}</h3>
              <p class="past-date">{{ past.start_time | date:'mediumDate' }}</p>
            </div>
            <div class="card-actions">
              <button (click)="viewSummary(past)" title="View Summary">ðŸ“„</button>
              <button (click)="scheduleAgain(past)" title="Schedule Again">ðŸ”„</button>
            </div>
          </header>
        </article>
      </div>
    </section>

  </div>
</main>

<div class="modal-backdrop" *ngIf="showModal" (click)="cancelSession()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <header class="modal-header">
      <h2>{{ isEditMode ? 'Edit Session' : 'Create New Session' }}</h2>
      <button class="close-btn" (click)="cancelSession()">&times;</button>
    </header>

    <form class="modal-form" (ngSubmit)="confirmSession()">
      <div class="form-group">
        <label for="title">Session Title <span class="required">*</span></label>
        <input id="title" type="text" [(ngModel)]="newSession.title" name="title" placeholder="e.g., Calculus II Final Review" required />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="start_time">Start Time <span class="required">*</span></label>
          <input id="start_time" type="datetime-local" [(ngModel)]="newSession.start_time" name="start_time" required />
        </div>
        <div class="form-group">
          <label for="end_time">End Time</label>
          <input id="end_time" type="datetime-local" [(ngModel)]="newSession.end_time" name="end_time" />
        </div>
      </div>

      <div class="form-group">
        <label for="location">Location or URL</label>
        <input id="location" type="text" [(ngModel)]="newSession.location" name="location" placeholder="e.g., Library Room 305 or https://meet.google.com/..." />
      </div>

      <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" [(ngModel)]="newSession.description" name="description" rows="3" placeholder="Add session details, topics to cover, etc."></textarea>
      </div>

      <p *ngIf="modalError" class="modal-error">{{ modalError }}</p>

      <footer class="modal-actions">
        <button type="button" class="btn-cancel" (click)="cancelSession()">Cancel</button>
        <button type="submit" class="btn-confirm">{{ isEditMode ? 'Save Changes' : 'Create Session' }}</button>
      </footer>
    </form>
  </div>
</div>
