<div *ngIf="isLoading$ | async" class="loading-overlay">
  <div class="spinner"></div>
  <p class="loading-text">Loading your sessions...</p>
</div>

<main *ngIf="!(isLoading$ | async)" class="sessions-page-container">

  <header class="page-header">
    <h1 style="margin-bottom: 0.75rem;">Study Sessions</h1>
    <p>Discover, join, and manage your study sessions.</p>
    <button class="create-session-btn" (click)="createSession()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      <span>Create Session</span>
    </button>
  </header>

  <section class="stats-section" *ngIf="userStats">
    <div class="stat-card">
      <h3>{{ userStats.totalHours }} hrs</h3>
      <p>Study Time (Last 7 Days)</p>
    </div>
    <div class="stat-card">
      <h3>{{ userStats.numSessions }}</h3>
      <p>Sessions Attended (Last 7 Days)</p>
    </div>
    <div class="stat-card">
      <h3>{{ filteredUpcomingSessions.length }}</h3>
      <p>Upcoming Sessions</p>
    </div>
  </section>

  <nav class="sessions-tabs">
    <button [class.active]="activeTab === 'suggestions'" (click)="activeTab = 'suggestions'">Suggestions</button>
    <button [class.active]="activeTab === 'discover'" (click)="activeTab = 'discover'">Discover</button>
    <button [class.active]="activeTab === 'future'" (click)="activeTab = 'future'">Future</button>
    <button [class.active]="activeTab === 'created'" (click)="activeTab = 'created'">My Sessions</button>
    <button [class.active]="activeTab === 'past'" (click)="activeTab = 'past'">Past</button>
  </nav>

  <div class="sessions-filters">
    <input
      type="text"
      [(ngModel)]="filters.search"
      (ngModelChange)="onFilterChange()"
      placeholder="Search by title or description..."
    />
    <select [(ngModel)]="filters.module" (ngModelChange)="onFilterChange()">
      <option value="">All My Modules</option>
      <option *ngFor="let mod of currentUserModules" [value]="mod.courseCode">{{ mod.courseName }}</option>
    </select>
    <input
      type="date"
      [(ngModel)]="filters.startDate"
      (ngModelChange)="onFilterChange()"
      placeholder="From date..."
    />
    <button class="btn-clear" (click)="clearFilters()">Clear</button>
  </div>

  <div class="tab-content">

    <section *ngIf="activeTab === 'suggestions'">
      <div class="session-list">
        <div *ngIf="filteredSuggestedSessions.length === 0" class="no-results-card">
          <p>No relevant sessions found that match your filters.</p>
          <span *ngIf="filters.search === '' && filters.module === '' && filters.startDate === ''">Try the "Discover" tab for all sessions.</span>
        </div>
        <article class="session-card" *ngFor="let session of filteredSuggestedSessions">
          <header class="card-header">
            <div class="session-info">
              <h3>{{ session.title }}</h3>
              <p class="session-creator">by {{ getCreatorName(session.creatorid) }}</p>
              <div class="session-badges">
                <span class="badge status-{{ session.status }}">{{ session.status }}</span>
<!--                <span class="badge type-participants">-->
<!--                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>-->
<!--                  {{ session.participantCount }}-->
<!--                 </span>-->
              </div>
            </div>
            <div class="card-actions">
              <button *ngIf="session.sessionId" class="btn-join" (click)="onJoinSession(session.sessionId)">
                Join Session
              </button>
            </div>
          </header>
          <div class="card-body">
            <p class="session-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              {{ session.start_time | date:'fullDate' }}
            </p>
            <p class="session-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
              {{ session.start_time | date:'shortTime' }} -
              <span *ngIf="session.end_time !== 'infinity'">{{ session.end_time | date:'shortTime' }}</span>
              <span *ngIf="session.end_time === 'infinity'">Ongoing</span>
            </p>
            <p *ngIf="session.creatorid" class="session-creator"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
              Created by: {{ getCreatorName(session.creatorid) }}
            </p>
          </div>
          <footer class="card-footer" *ngIf="session.description">
            <p>{{ session.description }}</p>
          </footer>
        </article>
      </div>
    </section>

    <section *ngIf="activeTab === 'discover'">
      <div class="session-list">
        <div *ngIf="filteredAllSessions.length === 0" class="no-results-card">
          <p>No active sessions match your filters.</p>
        </div>
        <article class="session-card" *ngFor="let session of filteredAllSessions">
          <header class="card-header">
            <div class="session-info">
              <h3>{{ session.title }}</h3>
              <p class="session-creator">by {{ getCreatorName(session.creatorid) }}</p>
              <div class="session-badges">
                <span class="badge status-{{ session.status }}">{{ session.status }}</span>
<!--                <span class="badge type-participants">-->
<!--                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>-->
<!--                  {{ session.participantCount }}-->
<!--                 </span>-->
              </div>
            </div>
            <div class="card-actions">
              <button *ngIf="session.sessionId" class="btn-join" (click)="onJoinSession(session.sessionId)">
                Join Session
              </button>
            </div>
          </header>
          <div class="card-body">
            <p class="session-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              {{ session.start_time | date:'fullDate' }}
            </p>
            <p class="session-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
              {{ session.start_time | date:'shortTime' }} -
              <span *ngIf="session.end_time !== 'infinity'">{{ session.end_time | date:'shortTime' }}</span>
              <span *ngIf="session.end_time === 'infinity'">Ongoing</span>
            </p>
            <p *ngIf="session.creatorid" class="session-creator"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
              Created by: {{ getCreatorName(session.creatorid) }}
            </p>
          </div>
          <footer class="card-footer" *ngIf="session.description">
            <p>{{ session.description }}</p>
          </footer>
        </article>
      </div>
    </section>

    <section *ngIf="activeTab === 'future'">
      <div class="session-list">
        <div *ngIf="filteredUpcomingSessions.length === 0" class="no-results-card">
          <p *ngIf="upcomingSessions_src.length === 0">You haven't joined any upcoming sessions.</p>
          <p *ngIf="upcomingSessions_src.length > 0">No sessions match your filters.</p>
          <span *ngIf="upcomingSessions_src.length === 0">Check the "Discover" tab to find one!</span>
        </div>
        <article class="session-card" *ngFor="let session of filteredUpcomingSessions">
          <header class="card-header">
            <div class="session-info">
              <h3>{{ session.title }}</h3>
              <p class="session-creator">by {{ getCreatorName(session.creatorid) }}</p>
              <div class="session-badges">
                <span class="badge status-{{ session.status }}">{{ session.status }}</span>
<!--                <span class="badge type-participants">-->
<!--                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>-->
<!--                  {{ session.participantCount }}-->
<!--                 </span>-->
              </div>
            </div>
            <div class="card-actions" *ngIf="session.sessionId">
              <button *ngIf="isSessionInProgress(session)" class="btn-enter" [routerLink]="['/session-room', session.sessionId]">
                Enter Session
              </button>

              <ng-container *ngIf="!isSessionInProgress(session)">
                <ng-container *ngIf="isCreator(session); else memberActions">
                  <button *ngIf="session.status !== 'scheduled'" class="btn-admin end" (click)="onEndSession(session.sessionId)" title="End Session Now">
                    <svg></svg>
                  </button>
                  <button class="btn-admin extend" (click)="onExtendSession(session.sessionId)" title="Extend Session">
                    <svg></svg>
                  </button>
                </ng-container>
                <ng-template #memberActions>
                  <button class="btn-leave" (click)="onLeaveSession(session.sessionId)">Leave Session</button>
                </ng-template>
              </ng-container>

            </div>
          </header>
          <div class="card-body">
            <p class="session-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              {{ session.start_time | date:'fullDate' }}
            </p>
            <p class="session-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
              {{ session.start_time | date:'shortTime' }} -
              <span *ngIf="session.end_time !== 'infinity'">{{ session.end_time | date:'shortTime' }}</span>
              <span *ngIf="session.end_time === 'infinity'">Ongoing</span>
            </p>
            <p *ngIf="session.creatorid" class="session-creator"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
              Created by: {{ getCreatorName(session.creatorid) }}
            </p>
          </div>
          <footer class="card-footer" *ngIf="session.description">
            <p>{{ session.description }}</p>
          </footer>
        </article>
      </div>
    </section>

    <section *ngIf="activeTab === 'created'">
      <div class="session-list">
        <div *ngIf="filteredMyCreatedSessions.length === 0" class="no-results-card">
          <p *ngIf="myCreatedSessions_src.length === 0">You haven't created any sessions.</p>
          <p *ngIf="myCreatedSessions_src.length > 0">No sessions match your filters.</p>
          <span *ngIf="myCreatedSessions_src.length === 0">Click "Create Session" to get started!</span>
        </div>
        <article class="session-card" *ngFor="let session of filteredMyCreatedSessions">
          <header class="card-header">
            <div class="session-info">
              <h3>{{ session.title }}</h3>
              <p class="session-creator">by {{ getCreatorName(session.creatorid) }}</p>
              <div class="session-badges">
                <span class="badge status-{{ session.status }}">{{ session.status }}</span>
<!--                <span class="badge type-participants">-->
<!--                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>-->
<!--                  {{ session.participantCount }}-->
<!--                 </span>-->
              </div>
            </div>
            <div class="card-actions" *ngIf="session.sessionId">
              <button *ngIf="isSessionInProgress(session)" class="btn-enter" [routerLink]="['/session-room', session.sessionId]">
                Enter Session
              </button>

              <ng-container *ngIf="!isSessionInProgress(session)">
                <button *ngIf="session.status === 'scheduled'" class="btn-admin" (click)="onEditSession(session)" title="Edit Session">
                  <svg></svg>
                </button>
                <button *ngIf="session.status !== 'scheduled'" class="btn-admin end" (click)="onEndSession(session.sessionId)" title="End Session Now">
                  <svg></svg>
                </button>
                <button class="btn-admin extend" (click)="onExtendSession(session.sessionId)" title="Extend Session">
                  <svg></svg>
                </button>
                <button class="btn-delete" (click)="onDeleteSession(session.sessionId)" title="Delete Session">
                  <svg></svg>
                </button>
              </ng-container>
            </div>
          </header>
          <div class="card-body">
            <p class="session-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              {{ session.start_time | date:'fullDate' }}
            </p>
            <p class="session-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
              {{ session.start_time | date:'shortTime' }} -
              <span *ngIf="session.end_time !== 'infinity'">{{ session.end_time | date:'shortTime' }}</span>
              <span *ngIf="session.end_time === 'infinity'">Ongoing</span>
            </p>
            <p *ngIf="session.creatorid" class="session-creator"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
              Created by: {{ getCreatorName(session.creatorid) }}
            </p>
          </div>
          <footer class="card-footer" *ngIf="session.description">
            <p>{{ session.description }}</p>
          </footer>
        </article>
      </div>
    </section>

    <section *ngIf="activeTab === 'past'">
      <div class="session-list">
        <div *ngIf="filteredPastSessions.length === 0" class="no-results-card">
          <p *ngIf="pastSessions_src.length === 0">No past sessions found.</p>
          <p *ngIf="pastSessions_src.length > 0">No sessions match your filters.</p>
        </div>
        <article class="session-card past" *ngFor="let past of filteredPastSessions">
          <header class="card-header">
            <div class="session-info">
              <h3>{{ past.title }}</h3>
              <p *ngIf="past.creatorid" class="session-creator-past">
                Created by: {{ getCreatorName(past.creatorid) }}
              </p>
              <p class="past-date">{{ past.start_time | date:'mediumDate' }}</p>
            </div>
            <div class="card-actions">
              <button (click)="viewSummary(past)" title="View Summary">ðŸ“„</button>
              <button (click)="scheduleAgain(past)" title="Schedule Again">ðŸ”„</button>
            </div>
          </header>
        </article>
      </div>
    </section>

  </div>
</main>

<div class="modal-backdrop" *ngIf="showModal" (click)="cancelSession()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <header class="modal-header">
      <h2>{{ isEditMode ? 'Edit Session' : 'Create New Session' }}</h2>
      <button class="close-btn" (click)="cancelSession()">&times;</button>
    </header>
    <form class="modal-form" (ngSubmit)="confirmSession()">
      <div class="form-group">
        <label for="title">Session Title <span class="required">*</span></label>
        <input id="title" type="text" [(ngModel)]="newSession.title" name="title" placeholder="e.g., Calculus II Final Review" required />
      </div>

<!--      <div class="form-group">-->
<!--        <label for="module">Module (Optional)</label>-->
<!--        <select id="module" [(ngModel)]="newSession.groupid" name="groupid">-->
<!--          <option value="">None (General Session)</option>-->
<!--          <option *ngFor="let mod of currentUserModules" [value]="mod.courseCode">-->
<!--            {{ mod.courseName }} ({{ mod.courseCode }})-->
<!--          </option>-->
<!--        </select>-->
<!--      </div>-->

      <div class="form-row">
        <div class="form-group">
          <label for="start_time">Start Time <span class="required">*</span></label>
          <input id="start_time" type="datetime-local" [(ngModel)]="newSession.start_time" name="start_time" required />
        </div>
        <div class="form-group">
          <label for="end_time">End Time</label>
          <input id="end_time" type="datetime-local" [(ngModel)]="newSession.end_time" name="end_time" />
        </div>
      </div>
      <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" [(ngModel)]="newSession.description" name="description" rows="3" placeholder="Add session details, topics to cover, etc."></textarea>
      </div>
      <p *ngIf="modalError" class="modal-error">{{ modalError }}</p>
      <footer class="modal-actions">
        <button type="button" class="btn-cancel" (click)="cancelSession()">Cancel</button>
        <button type="submit" class="btn-confirm">{{ isEditMode ? 'Save Changes' : 'Create Session' }}</button>
      </footer>
    </form>
  </div>
</div>
