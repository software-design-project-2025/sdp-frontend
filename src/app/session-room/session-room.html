<div *ngIf="isLoading$ | async" class="loading-overlay room-loading">
  <mat-spinner diameter="50"></mat-spinner>
  <p>Loading session room...</p>
</div>

<div *ngIf="sessionLoadingError$ | async as errorMsg" class="room-error-container">
  <h2>Error Loading Session</h2>
  <p>{{ errorMsg }}</p>
  <button mat-stroked-button color="primary" routerLink="/sessions">Back to Sessions</button>
</div>

<main *ngIf="!(isLoading$ | async) && !(sessionLoadingError$ | async)" class="session-room-container">

  <header class="room-header">
    <div class="header-info">
      <button mat-icon-button routerLink="/sessions" aria-label="Back to sessions list" class="back-button">
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      </button>
      <h1 *ngIf="session | async as sess">{{ sess.title }}</h1>
      <h1 *ngIf="!(session | async)">Session Room</h1>
    </div>

    <div class="timer-controls">
      <div class="timer">
        <span class="timer-label">Elapsed:</span>
        <span class="timer-value elapsed">{{ elapsedTime$ | async }}</span>
        <span class="timer-separator">|</span>
        <span class="timer-label">Remaining:</span>
        <span class="timer-value remaining">{{ remainingTime$ | async }}</span>
      </div>

      <ng-container *ngIf="(session | async) as sess">
        <button
          mat-flat-button color="warn"
          *ngIf="sess.creatorid === currentUserId && sess.status !== 'scheduled'" [disabled]="sessionEnded$ | async" (click)="confirmEndSession()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"></path></svg>
          End Session
        </button>
      </ng-container>
    </div>
  </header>

  <section class="chat-main">
    <section #messagesContainer class="messages-container" aria-live="polite">
      <div *ngIf="chatLoadingError$ | async as chatError" class="chat-error">
        <p>‚ö†Ô∏è {{ chatError }}</p>
      </div>
      <ng-container *ngIf="!(chatLoadingError$ | async)">
        <div *ngFor="let message of messages | async; trackBy: trackByMessageId" class="message-wrapper">
          <article class="message" [class.sent]="message.isCurrentUser" [class.received]="!message.isCurrentUser">
            <span class="sender-name" *ngIf="!message.isCurrentUser">{{ message.senderName }}</span>
            <div *ngIf="message.document; else textContent"
                 class="document-message" (click)="downloadDocument(message.document)"
                 tabindex="0" (keydown.enter)="downloadDocument(message.document)">
              <div class="doc-icon" aria-hidden="true">üìÑ</div>
              <div class="doc-info">
                <span class="doc-filename">{{ message.document.originalFilename }}</span>
                <span class="doc-action">Click to download</span>
              </div>
              <mat-spinner *ngIf="message.document.downloading" diameter="20" class="doc-spinner"></mat-spinner>
            </div>
            <ng-template #textContent><p>{{ message.content }}</p></ng-template>
            <time [attr.datetime]="message.timestamp.toISOString()">{{ message.timestamp | date:'shortTime' }}</time>
          </article>
        </div>
        <p *ngIf="(messages | async)?.length === 0 && !(chatLoadingError$ | async)" class="no-messages">
          Session started. Be the first to send a message!
        </p>
      </ng-container>
    </section>

    <footer class="message-input-section">
      <form [formGroup]="messageForm" (ngSubmit)="sendMessage()" class="message-form" aria-label="Send message">
        <input #fileInput type="file" (change)="onFileSelectedAndUpload($event)" style="display: none;">
        <button type="button" mat-icon-button (click)="triggerFileUpload()" aria-label="Attach a document" class="attach-button" [disabled]="isSending$ | async">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
        </button>
        <mat-form-field appearance="outline" class="message-input-field">
          <mat-label>Type a message...</mat-label>
          <input matInput id="message-input" type="text" formControlName="message" aria-required="true" autocomplete="off">
        </mat-form-field>
        <button type="submit" mat-flat-button color="primary" aria-label="Send message" [disabled]="messageForm.invalid || (isSending$ | async)" class="send-button">
          <svg *ngIf="!(isSending$ | async)" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M3.4 20.4l17.45-7.48c.81-.35.81-1.49 0-1.84L3.4 3.6c-.66-.29-1.39.2-1.39.91L2 9.12c0 .5.37.93.87.99L17 12 2.87 13.88c-.5.07-.87.5-.87 1l.01 4.61c0 .71.73 1.2 1.39.91z"/></svg>
          <mat-spinner *ngIf="isSending$ | async" diameter="20" class="send-spinner"></mat-spinner>
        </button>
      </form>
    </footer>
  </section>
</main>
