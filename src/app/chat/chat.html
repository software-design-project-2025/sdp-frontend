<main class="chat-container">
  <aside class="sidebar">
    <header class="sidebar-header">
      <h1>Messages</h1>
    </header>

    <section class="search-section">
      <form [formGroup]="searchForm" class="search-form">
        <label for="search-input" class="sr-only">Search conversations</label>
        <input 
          id="search-input"
          type="search" 
          placeholder="Search conversations..." 
          class="search-input"
          formControlName="searchTerm"
          aria-label="Search conversations">
      </form>
    </section>

    <nav *ngIf="!(loading | async)" class="conversations-nav" aria-label="Conversations">
      <ul class="conversations-list">
        <li 
          *ngFor="let conversation of filteredConversations; trackBy: trackByConversationId" 
          class="conversation-item"
          [class.active]="activeConversation?.id === conversation.id">
          <article 
            class="conversation-card" 
            (click)="setActiveConversation(conversation)"
            (keydown.enter)="setActiveConversation(conversation)"
            (keydown.space)="setActiveConversation(conversation)"
            tabindex="0"
            [attr.aria-label]="getConversationAriaLabel(conversation)"
            [attr.aria-current]="activeConversation?.id === conversation.id ? 'true' : null">
            
            <figure class="avatar" [attr.aria-label]="getAvatarAriaLabel(conversation)">
              <abbr 
                class="avatar-initials" 
                [title]="conversation.participant.name"
                [attr.aria-label]="conversation.participant.name + ' avatar'">
                {{ conversation.participant.name ? conversation.participant.name.charAt(0).toUpperCase() : 'U' }}
              </abbr>
            </figure>
            
            <section class="conversation-content">
              <header class="conversation-header">
                <h2>{{ conversation.participant.name || 'Unknown User' }}</h2>
                <time [attr.datetime]="conversation.timestamp.toISOString()">
                  {{ formatTime(conversation.timestamp) }}
                </time>
              </header>
              <p class="last-message">{{ conversation.lastMessage || 'Start a conversation' }}</p>
            </section>
            
            <output 
              *ngIf="conversation.unreadCount > 0" 
              class="message-count"
              [attr.aria-label]="conversation.unreadCount + ' unread messages'">
              {{ conversation.unreadCount }}
            </output>
          </article>
        </li>
      </ul>
      
      <p *ngIf="filteredConversations.length === 0" class="no-conversations">
        No conversations found
      </p>
    </nav>
    
    <p *ngIf="loading | async" class="loading-conversations">
      Loading conversations...
    </p>
  </aside>

  <section class="chat-main" *ngIf="activeConversation; else noConversation">
    <header class="chat-header">
      <section class="contact-info">
        <figure class="avatar" [attr.aria-label]="getAvatarAriaLabel(activeConversation)">
          <abbr 
            class="avatar-initials" 
            [title]="activeConversation.participant.name"
            [attr.aria-label]="activeConversation.participant.name + ' avatar'">
            {{ activeConversation.participant.name ? activeConversation.participant.name.charAt(0).toUpperCase() : 'U' }}
          </abbr>
        </figure>
        <section class="contact-details">
          <h2>{{ activeConversation.participant.name || 'Unknown User' }}</h2>
        </section>
      </section>
      
      <menu class="chat-actions" aria-label="Chat actions">
        <li>
          <button 
            type="button" 
            class="action-btn" 
            aria-label="Voice call"
            (click)="initiateCall(false)">
            ðŸ“ž
          </button>
        </li>
        <li>
          <button 
            type="button" 
            class="action-btn" 
            aria-label="Video call"
            (click)="initiateCall(true)">
            ðŸ“¹
          </button>
        </li>
        <li>
          <button 
            type="button" 
            class="action-btn" 
            aria-label="More options"
            (click)="showMoreOptions()">
            â‹®
          </button>
        </li>
      </menu>
    </header>

    <section class="messages-container" aria-label="Chat messages">
      <article 
        *ngFor="let message of activeConversation.messages; trackBy: trackByMessageId" 
        class="message"
        [class.sent]="message.type === 'sent'"
        [class.received]="message.type === 'received'"
        [attr.aria-label]="getMessageAriaLabel(message)">
        <blockquote cite="#">
          <p>{{ message.content }}</p>
          <footer>
            <time [attr.datetime]="message.timestamp.toISOString()">
              {{ formatTime(message.timestamp) }}
            </time>
          </footer>
        </blockquote>
      </article>
      
      <p *ngIf="activeConversation.messages.length === 0" class="no-messages">
        No messages yet. Start the conversation!
      </p>
    </section>

    <footer class="message-input-section">
      <form 
        [formGroup]="messageForm" 
        (ngSubmit)="sendMessage()" 
        class="message-form"
        aria-label="Send message">
        <label for="message-input" class="sr-only">Type your message</label>
        <input 
          id="message-input"
          type="text" 
          placeholder="Type a message..." 
          class="message-input"
          formControlName="message"
          aria-required="true">
        <button 
          type="submit" 
          class="send-button" 
          aria-label="Send message"
          [disabled]="messageForm.invalid">
          âž¤
        </button>
      </form>
    </footer>
  </section>

  <ng-template #noConversation>
    <section class="no-conversation">
      <p>Select a conversation to start messaging</p>
    </section>
  </ng-template>
</main>