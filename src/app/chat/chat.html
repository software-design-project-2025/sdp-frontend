<main class="chat-container">
  <aside class="sidebar">
    <header class="sidebar-header">
      <h1>Messages</h1>
    </header>

    <section class="search-section">
      <form [formGroup]="searchForm" class="search-form">
        <label for="search-input" class="sr-only">Search conversations</label>
        <input
          id="search-input"
          type="search"
          placeholder="Search conversations..."
          class="search-input"
          formControlName="searchTerm"
          aria-label="Search conversations">
      </form>
    </section>

    @if (!(loading$ | async)) {
      <nav class="conversations-nav" aria-label="Conversations">
        <ul class="conversations-list">
          @for (conversation of filteredConversations; track trackByConversationId) {
            <li class="conversation-item" [class.active]="activeConversation?.id === conversation.id">
              <article
                class="conversation-card"
                (click)="setActiveConversation(conversation)"
                (keydown.enter)="setActiveConversation(conversation)"
                tabindex="0"
                [attr.aria-label]="getConversationAriaLabel(conversation)"
                [attr.aria-current]="activeConversation?.id === conversation.id">

                <figure class="avatar" [attr.aria-label]="getAvatarAriaLabel(conversation)">
                  @if (conversation.participant.profile_picture && !isImageLoadingError(conversation)) {
                    <img
                      [src]="conversation.participant.profile_picture"
                      [alt]="conversation.participant.name + ' profile picture'"
                      class="profile-avatar-image"
                      (error)="handleImageError($event, conversation)">
                  } @else {
                    <abbr class="avatar-initials" [title]="conversation.participant.name">
                      {{ conversation.participant.name ? conversation.participant.name.charAt(0).toUpperCase() : 'U' }}
                    </abbr>
                  }
                </figure>

                <section class="conversation-content">
                  <header class="conversation-header">
                    <h3>{{ conversation.participant.name || 'Unknown User' }}</h3>
                    @if (conversation.timestamp) {
                      <time [attr.datetime]="conversation.timestamp.toISOString()">
                        {{ formatTime(conversation.timestamp) }}
                      </time>
                    }
                    @if (conversation.unreadCount > 0) {
                      <output class="message-count" [attr.aria-label]="conversation.unreadCount + ' unread messages'">
                        {{ conversation.unreadCount }}
                      </output>
                    }
                  </header>
                  <p class="last-message">
                    {{ conversation.lastMessage || 'Start a conversation' }}
                  </p>
                </section>
              </article>
            </li>
          }
        </ul>
        @if (filteredConversations.length === 0) {
          <p class="no-conversations">No conversations found</p>
        }
      </nav>
    } @else {
      <nav class="conversations-nav conversations-loading" aria-label="Conversations loading">
        <ul class="conversations-list">
          @for (item of [1,2,3,4,5]; track trackByIndex) {
            <li class="conversation-item">
              <article class="conversation-card" tabindex="-1" aria-hidden="true">
                <figure class="avatar skeleton skeleton-avatar"><abbr class="avatar-initials"></abbr></figure>
                <section class="conversation-content">
                  <header class="conversation-header">
                    <h3 class="skeleton skeleton-text skeleton-text-medium"></h3>
                    <time class="skeleton skeleton-text skeleton-text-short"></time>
                  </header>
                  <p class="last-message skeleton skeleton-text skeleton-text-long"></p>
                </section>
              </article>
            </li>
          }
        </ul>
      </nav>
    }
  </aside>

  @if (activeConversation) {
    <section class="chat-main">
      <header class="chat-header" [class.chat-header-loading]="messagesLoading$ | async">
        <section class="contact-info">
          <figure class="avatar" [attr.aria-label]="getAvatarAriaLabel(activeConversation)">
            @if (activeConversation.participant.profile_picture && !isImageLoadingError(activeConversation)) {
              <img
                [src]="activeConversation.participant.profile_picture"
                [alt]="activeConversation.participant.name + ' profile picture'"
                class="profile-avatar-image"
                (error)="handleImageError($event, activeConversation)">
            } @else {
              <abbr class="avatar-initials" [title]="activeConversation.participant.name">
                {{ activeConversation.participant.name ? activeConversation.participant.name.charAt(0).toUpperCase() : 'U' }}
              </abbr>
            }
          </figure>
          <section class="contact-details">
            <h2>{{ activeConversation.participant.name || 'Unknown User' }}</h2>
          </section>
        </section>
      </header>

      <section #messagesContainer class="messages-container" [class.messages-loading]="messagesLoading$ | async" aria-live="polite">
        @if (messagesLoading$ | async) {
          <div class="message-container">
            @for (item of [1,2,3,4,5]; track trackByIndex) {
              <article class="message" [class.sent]="item % 2 === 0" [class.received]="item % 2 !== 0" aria-hidden="true">
                <p [class]="item % 2 === 0 ? 'skeleton skeleton-message sent' : 'skeleton skeleton-message received'"></p>
                <time class="skeleton skeleton-text skeleton-text-short"></time>
              </article>
            }
          </div>
        } @else {
          @for (message of activeConversation.messages; track trackByMessageId) {
            <article class="message" [class.sent]="message.type === 'sent'" [class.received]="message.type === 'received'" [attr.aria-label]="getMessageAriaLabel(message)">
              @if (message.document) {
                <div class="document-message" (click)="downloadDocument(message.document)" tabindex="0" (keydown.enter)="downloadDocument(message.document)">
                  <div class="doc-icon" aria-hidden="true">ðŸ“„</div>
                  <div class="doc-info">
                    <span class="doc-filename">{{ message.document.originalFilename }}</span>
                    <span class="doc-action">Click to download</span>
                  </div>
                  @if (message.document.downloading) {
                    <div class="doc-spinner"></div>
                  }
                </div>
              } @else {
                <p>{{ message.content }}</p>
              }
              <time [attr.datetime]="message.timestamp.toISOString()">{{ formatTime(message.timestamp) }}</time>
            </article>
          }

          @if (activeConversation.messages.length === 0) {
            <p class="no-messages">No messages yet. Start the conversation!</p>
          }
        }
      </section>

      <footer class="message-input-section" [class.message-input-loading]="messagesLoading$ | async">
        <form [formGroup]="messageForm" (ngSubmit)="sendMessage()" class="message-form" aria-label="Send message">
          <input #fileInput type="file" (change)="onFileSelectedAndUpload($event)" style="display: none;">
          <input id="message-input" type="text" placeholder="Type a message..." class="message-input" formControlName="message" aria-required="true">
          <button type="button" class="attach-button" (click)="triggerFileUpload()" aria-label="Attach a document">ðŸ“Ž</button>
          <button type="submit" class="send-button" aria-label="Send message" [disabled]="messageForm.invalid || (messagesLoading$ | async)">âž¤</button>
        </form>
      </footer>
    </section>
  } @else {
    <section class="no-conversation">
      <article class="empty-state">
        <figure class="empty-state-icon" aria-hidden="true">ðŸ’¬</figure>
        <h2 class="empty-state-title">Your Messages Await</h2>
        <p class="empty-state-text">Choose a conversation from the sidebar to dive into the chat</p>
      </article>
    </section>
  }
</main>
