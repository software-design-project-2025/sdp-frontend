<main class="chat-container">
  <aside class="sidebar">
    <header class="sidebar-header">
      <h1>Messages</h1>
    </header>

    <section class="search-section">
      <form [formGroup]="searchForm" class="search-form">
        <label for="search-input" class="sr-only">Search conversations</label>
        <input 
          id="search-input"
          type="search" 
          placeholder="Search conversations..." 
          class="search-input"
          formControlName="searchTerm"
          aria-label="Search conversations">
      </form>
    </section>

    <nav 
      *ngIf="!(loading | async); else conversationsLoading" 
      class="conversations-nav" 
      aria-label="Conversations">
      <ul class="conversations-list">
        <li 
          *ngFor="let conversation of filteredConversations; trackBy: trackByConversationId" 
          class="conversation-item"
          [class.active]="activeConversation?.id === conversation.id">
          <article 
            class="conversation-card" 
            (click)="setActiveConversation(conversation)"
            (keydown.enter)="setActiveConversation(conversation)"
            (keydown.space)="setActiveConversation(conversation)"
            tabindex="0"
            [attr.aria-label]="getConversationAriaLabel(conversation)"
            [attr.aria-current]="activeConversation?.id === conversation.id ? 'true' : null">
            
            <figure class="avatar" [attr.aria-label]="getAvatarAriaLabel(conversation)">
              <abbr 
                class="avatar-initials" 
                [title]="conversation.participant.name"
                [attr.aria-label]="conversation.participant.name + ' avatar'">
                {{ conversation.participant.name ? conversation.participant.name.charAt(0).toUpperCase() : 'U' }}
              </abbr>
            </figure>
            
            <section class="conversation-content">
              <header class="conversation-header">
                <h2>{{ conversation.participant.name || 'Unknown User' }}</h2>
                <time [attr.datetime]="conversation.timestamp.toISOString()">
                  {{ formatTime(conversation.timestamp) }}
                </time>
              </header>
              <p class="last-message">{{ conversation.messages[conversation.messages.length-1]?.content || 'Start a conversation' }}</p>
            </section>
            
            <output 
              *ngIf="conversation.unreadCount > 0" 
              class="message-count"
              [attr.aria-label]="conversation.unreadCount + ' unread messages'">
              {{ conversation.unreadCount }}
            </output>
          </article>
        </li>
      </ul>
      
      <p *ngIf="filteredConversations.length === 0" class="no-conversations">
        No conversations found
      </p>
    </nav>
    
    <ng-template #conversationsLoading>
      <nav class="conversations-nav conversations-loading" aria-label="Conversations loading">
        <ul class="conversations-list">
          <li *ngFor="let item of [1,2,3,4,5]" class="conversation-item">
            <article class="conversation-card" tabindex="0" aria-hidden="true">
              <figure class="avatar skeleton-avatar skeleton">
                <abbr class="avatar-initials"> </abbr>
              </figure>
              
              <section class="conversation-content">
                <header class="conversation-header">
                  <h2 class="skeleton skeleton-text medium">Loading username</h2>
                  <time class="skeleton skeleton-text short">00:00</time>
                </header>
                <p class="last-message skeleton skeleton-text long">Loading last message content</p>
              </section>
            </article>
          </li>
        </ul>
      </nav>
    </ng-template>
  </aside>

  <section class="chat-main" *ngIf="activeConversation; else noConversationSelected">
    <header class="chat-header" [class.chat-header-loading]="messagesLoading | async">
      <section class="contact-info">
        <figure class="avatar" [attr.aria-label]="getAvatarAriaLabel(activeConversation)">
          <abbr 
            class="avatar-initials" 
            [title]="activeConversation.participant.name"
            [attr.aria-label]="activeConversation.participant.name + ' avatar'">
            {{ activeConversation.participant.name ? activeConversation.participant.name.charAt(0).toUpperCase() : 'U' }}
          </abbr>
        </figure>
        <section class="contact-details">
          <h2>{{ activeConversation.participant.name || 'Unknown User' }}</h2>
        </section>
      </section>
    </header>

    <section 
      class="messages-container" 
      [class.messages-loading]="messagesLoading | async"
      aria-label="Chat messages">
      
      <article 
        *ngIf="(messagesLoading | async); else loadedMessages"
        class="message-container">
        <article *ngFor="let item of [1,2,3,4,5,6,7]" 
                 class="message"
                 [class.sent]="item % 2 === 0"
                 [class.received]="item % 2 === 1"
                 aria-hidden="true">
          <blockquote cite="#">
            <p class="skeleton-message skeleton">{{ item % 2 === 0 ? 'Sent message content' : 'Received message content' }}</p>
            <footer>
              <time class="skeleton skeleton-text short">00:00</time>
            </footer>
          </blockquote>
        </article>
      </article>
      
      <ng-template #loadedMessages>
        <article 
          *ngFor="let message of activeConversation.messages; trackBy: trackByMessageId" 
          class="message"
          [class.sent]="message.type === 'sent'"
          [class.received]="message.type === 'received'"
          [attr.aria-label]="getMessageAriaLabel(message)">
          <blockquote cite="#">
            <p>{{ message.content }}</p>
            <footer>
              <time [attr.datetime]="message.timestamp.toISOString()">
                {{ formatTime(message.timestamp) }}
              </time>
            </footer>
          </blockquote>
        </article>
        
        <p *ngIf="activeConversation.messages.length === 0" class="no-messages">
          No messages yet. Start the conversation!
        </p>
      </ng-template>
    </section>

    <footer class="message-input-section" [class.message-input-loading]="messagesLoading | async">
      <form 
        [formGroup]="messageForm" 
        (ngSubmit)="sendMessage()" 
        class="message-form"
        aria-label="Send message">
        <label for="message-input" class="sr-only">Type your message</label>
        <input 
          id="message-input"
          type="text" 
          placeholder="Type a message..." 
          class="message-input"
          formControlName="message"
          aria-required="true">
        <button 
          type="submit" 
          class="send-button" 
          aria-label="Send message"
          [disabled]="messageForm.invalid || (messagesLoading | async)">
          âž¤
        </button>
      </form>
    </footer>
  </section>

  <ng-template #noConversationSelected>
    <section class="no-conversation">
      <p>Select a conversation to start messaging</p>
    </section>
  </ng-template>
</main>